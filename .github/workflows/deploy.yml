name: Deploy em VM Oracle

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar ambiente remoto
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VM_HOST }}        # IP público da VM Oracle
          username: ${{ secrets.VM_USER }}    # usuário SSH (ex: ubuntu ou opcionalmente opc)
          key: ${{ secrets.VM_SSH_KEY }}      # chave privada SSH
          script: |
            set -e

            # Atualiza repositório do projeto
            cd ~/relatorios || git clone https://github.com/${{ github.repository }} ~/relatorios
            cd ~/relatorios
            git pull origin main

            # Cria .env com variáveis de ambiente seguras
            cat > .env <<EOF
            MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
            MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
            RABBITMQ_USER=${{ secrets.RABBITMQ_USER }}
            RABBITMQ_PASS=${{ secrets.RABBITMQ_PASS }}
            MAILTRAP_HOST=${{ secrets.MAILTRAP_HOST }}
            MAILTRAP_PORT=${{ secrets.MAILTRAP_PORT }}
            MAILTRAP_USER=${{ secrets.MAILTRAP_USER }}
            MAILTRAP_PASS=${{ secrets.MAILTRAP_PASS }}
            EMAIL_TO=${{ secrets.EMAIL_TO }}
            EOF

            # Instala Docker e Compose se ainda não tiver
            if ! command -v docker >/dev/null; then
              sudo apt update
              sudo apt install -y docker.io docker-compose
              sudo systemctl enable docker
              sudo systemctl start docker
            fi

            # Sobe containers
            sudo docker-compose down || true
            sudo docker-compose up -d --build

            # Mostra containers em execução
            sudo docker ps -a
